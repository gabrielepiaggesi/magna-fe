<div class="h110 flex fColumn gap20 pad10 pRel" style="padding-bottom: 90px;">
    <ng-container *ngIf="!loading">
        <ng-container *ngIf="(discounts$ | async) as discounts">
            <div *ngFor="let discount of discounts">
                <app-discount-preview [discount]="discount" (click)="open('discount', discount)"></app-discount-preview>
            </div>
            <div *ngIf="!discounts.length" class="flex fRow fCenter pad20 br10 bgrR boxSha disc">
                <h3>{{ (tr?.discountSlogan || 'Completa almeno una carta fedeltà per ricevere i tuoi premi!') }}&nbsp;<i class="fa-solid fa-gift"></i></h3>
            </div>
            <div class="spacer"></div>
        </ng-container>

        <ng-container *ngIf="(fidelityCards$ | async) as fidelityCards">
            <div *ngFor="let fidelityCard of fidelityCards">
                <app-fidelity-preview [fidelity]="fidelityCard" [discountPresent]="discountsBusinessIds.includes(fidelityCard.business_id)" (click)="open('fidelity-card', fidelityCard)"></app-fidelity-preview>
            </div>
            <button *ngIf="!fidelityCards.length"
                    type="button" 
                    class="w100 br10 btn1 bgrG boxSha pad20 brN w100" 
                    (click)="go('incIntro')"
                >
                {{ (tr?.newCard || '+NUOVA CARTA FEDELTÀ') }}
                </button>
            <div *ngIf="!!(appService.showHack | async) && showHack && !!fidelityCards.length" class="flex fColumn pad20 bgrG gap10 br10 pRel" (click)="go('redeem')">
                <div class="tRBadge tRBadgeBor bgrR">
                    <i class="fa-solid fa-xmark" style="margin-left: auto;" (click)="showHack = false"></i>
                </div>
                <h4 class="fw7">Ti diamo 50€ per ogni locale che convinci a usare COMEBACK!</h4>
            </div>
        </ng-container>

        <div *ngIf="appService.userInfo && !appService.userInfo.cap" class="flex fColumn pad20 bgrG gap10 br10 pRel" (click)="go('businesses')">
            <h4 class="fw7">{{ (tr?.cap || 'Imposta il CAP della tua zona per trovare locali e sconti vicino a te!') }} &nbsp; <i class="fa-solid fa-arrow-right"></i></h4>
        </div>

        <ng-container *ngIf="(businessesSuggested$ | async) as businessesSuggested">
            <div *ngIf="businessesSuggested.length" class="spacer"></div>
            <div *ngFor="let businessSuggested of businessesSuggested">
                <app-business-preview [fidelity]="businessSuggested" (click)="open('fidelity-card', businessSuggested, true)"></app-business-preview>
            </div>
        </ng-container>

    </ng-container>
    <div *ngIf="!!loading" class="spinner mAuto"></div>
</div>


<app-overlay *ngIf="entityOpened && entityTypeOpened" class="bgrWl" (close)="closeOverlay()">
    <app-fidelity-qr *ngIf="entityTypeOpened === 'fidelity-card'" [isSuggested]="isSuggested" [discountPresent]="discountsBusinessIds.includes(entityOpened.business_id)" [fidelityCard]="entityOpened" (clickCard)="clickCard = true" (close)="closeOverlay($event, true)"></app-fidelity-qr>
    <app-discount-qr *ngIf="entityTypeOpened === 'discount'" [discount]="entityOpened" (close)="closeOverlay(null, true)"></app-discount-qr>
</app-overlay>